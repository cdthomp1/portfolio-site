<!DOCTYPE html>
<html>

<head>
    <title>Admin: Cameron Thompson</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&family=Russo+One&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="default.css">
    <link id="theme-style" rel="stylesheet" type="text/css" href="">
    <link href="prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="admin.css">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
    <div id="easterEgg"><img src="https://media.giphy.com/media/Ihz5w0ugweeFod06di/giphy.gif"></div>
    <div id="login" data-netlify-identity-menu></div>
    <section class="s1">
        <div class="main-container">
            <h1>Admin Panel</h1>
            <div class="intro-wrapper">
                <div class="left-column">
                    <div class="wrapper">
                        <div class="nav-wrapper">
                            <div class="dots-wrapper">
                                <div id="dot-1" class="browser-dot"></div>
                                <div id="dot-2" class="browser-dot"></div>
                                <div id="dot-3" class="browser-dot"></div>
                            </div>

                            <ul id="navigation">
                                <li>Add Project</li>
                            </ul>
                        </div>

                        <div class="post">

                            <label>Title</label> <input class="input-field" type="text" name="title" id="title"><br />
                            <label>Image</label><input class="input-field" type="text" name="image" id="image"><br />
                            <label>Repo Link</label><input class="input-field" type="text" name="repo-link"
                                id="repo-link"><br />
                            <label>Live Link</label><input class="input-field" type="text" name="live-link"
                                id="live-link"><br />
                            <label>Description</label> <textarea class="input-field" type="text" name="description"
                                id="description"></textarea><br />

                            <button id="add-btn" onclick="addProject()">Add</button>
                        </div>
                    </div>
                </div>
                <div class="right-column">
                    <div class="wrapper proj-table">
                        <div class="nav-wrapper">
                            <div class="dots-wrapper">
                                <div id="dot-1" class="browser-dot"></div>
                                <div id="dot-2" class="browser-dot"></div>
                                <div id="dot-3" class="browser-dot"></div>
                            </div>

                            <ul id="navigation">
                                <li>Projects</li>
                            </ul>
                        </div>

                        <div class="projectTable">
                            <table id='projects'>
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Repo Link</th>
                                        <th>Live Link</th>
                                    </tr>
                                </thead>
                                <tbody id="projectTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>




    <script type="text/javascript" src="script.js"></script>
    <script src="prism.js"></script>

    <script>
        displayProjects();
        
        netlifyIdentity.init();
        var thing = document.getElementById("login").childNodes;
        thing[0].remove()
        
            
        
        netlifyIdentity.on('login', user => location.reload());
        netlifyIdentity.on('logout', () => token = null);
        function addProject() {
            try {
                var token = netlifyIdentity.currentUser().token.access_token; 
            }catch (err) {
                console.error("Can't get Token")
            }
            
            var title = document.getElementById('title').value;
            var des = document.getElementById('description').value;
            var image = document.getElementById('image').value;
            var repoLink = document.getElementById('repo-link').value;
            var liveLink = document.getElementById('live-link').value;


            if (token) {
                fetch(`/api/addproject`, {
                        method: 'POST',
                        headers: {
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            title: title,
                            description: des,
                            image: image,
                            repoLink: repoLink,
                            liveLink: liveLink
                        })
                    })
                    .then(response => response.json())
                    .then(json => {
                        console.log(json)
                        displayProjects();
                        clearAddForm();
                        showEasterEgg();
                    });
            } else {
                alert('Please Log In')
            }

        }

        function clearAddForm() {
            document.getElementById('title').value = '';
            document.getElementById('description').value = '';
            document.getElementById('image').value = '';
            document.getElementById('repo-link').value = '';
            document.getElementById('live-link').value = '';
        }

        function showEasterEgg() {
            document.getElementById('easterEgg').style.visibility = 'visible';
            setTimeout(function(){ document.getElementById('easterEgg').style.visibility = 'hidden'; }, 5000);
        }

        async function displayProjects() {
            const projects = await fetch('/api/getProjects')
                .then(response => response.json())
                .then(json => {
                    return json
                });

            const table = document.getElementById("projectTableBody");
            table.innerHTML = '';
            projects.forEach(item => {
                let row = table.insertRow();
                let title = row.insertCell(0);
                title.innerHTML = item.title;
                let repo = row.insertCell(1);
                repo.innerHTML = `<a href="${item.repoLink}" target="_blank">${item.repoLink}</a>`;
                let live = row.insertCell(2);
                live.innerHTML = `<a href="${item.liveLink}" target="_blank">${item.liveLink}</a>`;
            });
        }

    </script>
</body>

</html>